(()=>{"use strict";const e=(e,t)=>{$(e).on("click",(function(){if(!$(t).val().length)return;const e=$(this).parents("form");e.find("[name=ids\\[\\]]").remove();let a=!1;$("input[name=ids\\[\\]]:checked").each((function(){$("<input>").attr({type:"hidden",name:"ids[]"}).val($(this).val()).appendTo(e),a=!0})),a&&(e.find("[name=operate]").val($(this).val()),e.submit())}))},t=(e,t,a)=>{const n=document.querySelector(e);if(n){const e=(e,t,a)=>{const o=e.split(",").map((e=>e.trim())),s=document.createElement("select");s.id=a,s.className=t,s.multiple=!0;for(const e of n.options){const t=document.createElement("option");t.value=e.value,t.text=e.text,o.includes(t.text)&&t.setAttribute("selected","selected"),s.appendChild(t)}return s},o=(e,a,n)=>{e.select2({width:"resolve",placeholder:"Multi-select",closeOnSelect:!1,allowClear:!1}),e.select2("open"),e.on("select2:close",(function(e){const o=Array.from(this.options).filter((e=>e.selected)).map((e=>e.text)).join(", ");let s=Array.from(this.options).filter((e=>e.selected)).map((e=>e.value));for(0==s.length&&(s=[""]);a.firstChild;)a.removeChild(a.firstChild);a.innerText=o;const i=a.getAttribute("data-value");i!==o&&(e.preventDefault(),$.ajax({type:"PATCH",url:"/catalog_tags/field_update/",data:{id:n,catalog_tag:{[t]:s}},dataType:"json"}).done((function(e){"SUCCESS"===e.status||(console.log(`${paramName} changed: ${targetId} : ${column} : ${value} : status ${e.status}`),e.message&&(alert(e.message),console.log(e.message)),a.innerText=i)})).fail((function(e,t){console.log(`tag change failed: ${n} : ${s} : ${t}`),a.innerText=i})))}))};for(const t of document.querySelectorAll(a))t.addEventListener("click",(function(t){const a=this;if(a.querySelector(".tmp-select"))return;const n=a.parentNode?.id?.slice(4);a.setAttribute("data-value",a.innerText);const s=e(a.innerText,"tmp-select",`tmp-select-${n}`);a.innerText="",a.appendChild(s),o($(s),a,n)}))}};class a{constructor(e,t,a,n){this.dialog=document.getElementById(e),this.trigger=document.getElementById(t),this.backGround=document.getElementById(a),this.submitCallback=n,this.setupShowDialog(),this.setupHideDialog()}setupShowDialog(){this.trigger?.addEventListener("click",(()=>{this.dialog&&(this.dialog.showModal(),this.dialog.style.visibility="visible",this.dialog.classList.remove("is-motioned"),this.dialog.setAttribute("tabIndex","0"),this.dialog.focus())}))}setupHideDialog(){this.dialog&&(this.dialog.querySelector(".dialog-button-submit")?.addEventListener("click",(()=>{this.submitCallback&&this.submitCallback(this.dialog),this.hideProcess("submit")})),this.dialog.querySelector(".dialog-button-cancel")?.addEventListener("click",(()=>{this.hideProcess("cancel")})),this.dialog.addEventListener("cancel",(()=>{this.hideProcess("cancel from escape key")})))}hideProcess(e){this.dialog&&(this.dialog.close(e),this.dialog.classList.add("is-motioned"),this.backGround&&(this.backGround.setAttribute("tabIndex","0"),this.backGround.focus()),setTimeout((()=>{this.dialog.style.visibility="hidden"}),250))}}class n{constructor(e){this.targetId=e.id.slice(21),this.columns=new Map;for(const t of e.querySelectorAll(".editable")){const e=t.classList.item(0);this.columns.set(e,t),t.contentEditable=!0,t.setAttribute("data-value",t.innerText),t.addEventListener("keydown",(e=>{"Enter"===e.key&&e.preventDefault()})),t.addEventListener("focusout",(e=>{this.#e(e)})),t.addEventListener("focusin",(e=>{e.target.setAttribute("data-value",e.target.innerText)}))}}static init(){for(const e of document.querySelectorAll(".edit-category"))new n(e);new a("dialog-new-catalog-tag-category","add-catalog-tag-category","tab-content-manage_tag_categories",this.#t)}static makeTableRow(e){const t=document.createElement("a");t.classList.add("icon","icon-del"),t.setAttribute("data-method","delete"),t.setAttribute("data-confirm","よろしいですか？"),t.setAttribute("rel","nofollow"),t.href=`/catalog_tag_categories/${e.id}`,t.appendChild(document.createTextNode("削除"));const a=document.createElement("td");a.classList.add("name","editable"),a.appendChild(document.createTextNode(e.name));const o=document.createElement("td");o.classList.add("description","editable"),o.appendChild(document.createTextNode(e.description));const s=document.createElement("td");s.classList.add("buttons"),s.appendChild(t);const i=document.createElement("tr");return i.id=`catalog_tag_category-${e.id}`,i.classList.add("edit-category"),i.appendChild(a),i.appendChild(o),i.appendChild(s),new n(i),i}static#t(e){if(!e)return;const t=e.querySelector("input[name='catalog_tag_category[name]']").value,a=e.querySelector("input[name='catalog_tag_category[description]']").value;$.ajax({type:"POST",url:`/projects/${IssuesCatalogSettingParam.project?.identifier}/catalog_tag_categories.json`,headers:{"X-Redmine-API-Key":IssuesCatalogSettingParam.user.apiKey},dataType:"text",format:"json",data:{catalog_tag_category:{name:t,description:a}}}).done((e=>{if(e.startsWith("{")){const t=document.querySelector("table.catalog-tag-categories")?.querySelector("tbody");if(t){const a=JSON.parse(e),o=n.makeTableRow(a.catalog_tag_category);t.insertBefore(o,t.lastElementChild)}}else console.log(e)})).fail(((e,t)=>{const a=e.responseText.startsWith("{")?Object.entries(JSON.parse(e.responseText)).map((([e,t])=>`${e} : ${t}`)).join("\n"):e.responseText;alert(a),console.log(a)}))}#e(e){const t=e.target;t.innerText=t.innerText.replace(/[\r\n]/g,"");const a=t.getAttribute("data-value");if(a===t.innerText)return!0;if(0===t.innerText.length)return t.innerText=a,!0;e.preventDefault();const o=t.classList.item(0),s=t.innerText||"__none__",i={};i[o]=s,$.ajax({type:"PUT",url:`/catalog_tag_categories/${this.targetId}.json`,headers:{"X-Redmine-API-Key":IssuesCatalogSettingParam.user.apiKey},dataType:"json",format:"json",data:{catalog_tag_category:i}}).done(((e,i,r)=>{r.status>=200&&r.status<300||304===r.status?"name"===o&&n.#a(a,s):t.innerText=a})).fail((e=>{const n=e.responseText.startsWith("{")?Object.entries(JSON.parse(e.responseText)).map((([e,t])=>`${e} : ${t}`)).join("\n"):e.responseText;alert(`「${t.innerText}」\n ${n}`),console.log(`「${t.innerText}」 ${n}`),t.innerText=a}))}static#a(e,t){for(const a of document.querySelectorAll(".edit2-tag"))a.innerText.includes(e)&&(a.innerText=a.innerText.replace(e,t));const a=document.querySelector("#work-tag-category");for(const n of a?.options)n.text===e&&(n.text=t);const n=document.querySelector("#select-catalog-tag-categories");for(const a of n?.options)a.text===e&&(a.text=t);$(n)?.val(null).trigger("change")}}class o{constructor(e){this.targetId=e.id.slice(18),this.columns=new Map;for(const t of e.querySelectorAll(".editable")){const e=t.classList.item(0);this.columns.set(e,t),t.contentEditable=!0,t.setAttribute("data-value",t.innerText),t.addEventListener("keydown",(e=>{"Enter"===e.key&&e.preventDefault()})),t.addEventListener("focusout",(e=>{this.#e(e)})),t.addEventListener("focusin",(e=>{e.target.setAttribute("data-value",e.target.innerText)}))}}static init(){for(const e of document.querySelectorAll(".edit-group"))new o(e);new a("dialog-new-catalog-tag-group","add-catalog-tag-group","tab-content-manage_tag_groups",this.#t)}static makeTableRow(e){const t=document.createElement("a");t.classList.add("icon","icon-del"),t.setAttribute("data-method","delete"),t.setAttribute("data-confirm","よろしいですか？"),t.setAttribute("rel","nofollow"),t.href=`/catalog_tag_groups/${e.id}`,t.appendChild(document.createTextNode("削除"));const a=document.createElement("td");a.classList.add("name","editable"),a.appendChild(document.createTextNode(e.name));const n=document.createElement("td");n.classList.add("description","editable"),n.appendChild(document.createTextNode(e.description));const s=document.createElement("td");s.classList.add("buttons"),s.appendChild(t);const i=document.createElement("tr");return i.id=`catalog_tag_group-${e.id}`,i.classList.add("edit-group"),i.appendChild(a),i.appendChild(n),i.appendChild(s),new o(i),i}static#t(e){if(!e)return;const t=e.querySelector("input[name='catalog_tag_group[name]']").value,a=e.querySelector("input[name='catalog_tag_group[description]']").value;$.ajax({type:"POST",url:`/projects/${IssuesCatalogSettingParam.project?.identifier}/catalog_tag_groups.json`,headers:{"X-Redmine-API-Key":IssuesCatalogSettingParam.user.apiKey},dataType:"text",format:"json",data:{catalog_tag_group:{name:t,description:a}}}).done((e=>{if(e.startsWith("{")){const t=document.querySelector("table.catalog-tag-groups")?.querySelector("tbody");if(t){const a=JSON.parse(e),n=o.makeTableRow(a.catalog_tag_group);t.appendChild(n)}}else console.log(e)})).fail(((e,t)=>{const a=e.responseText.startsWith("{")?Object.entries(JSON.parse(e.responseText)).map((([e,t])=>`${e} : ${t}`)).join("\n"):e.responseText;alert(a),console.log(a)}))}#e(e){const t=e.target;t.innerText=t.innerText.replace(/[\r\n]/g,"");const a=t.getAttribute("data-value");if(a===t.innerText)return!0;if(0===t.innerText.length)return t.innerText=a,!0;e.preventDefault();const n=t.classList.item(0),s=t.innerText||"__none__",i={};i[n]=s,$.ajax({type:"PUT",url:`/catalog_tag_groups/${this.targetId}.json`,headers:{"X-Redmine-API-Key":IssuesCatalogSettingParam.user.apiKey},dataType:"json",format:"json",data:{catalog_tag_group:i}}).done(((e,i,r)=>{r.status>=200&&r.status<300||304===r.status?"name"===n&&o.#n(a,s):t.innerText=a})).fail((e=>{const n=e.responseText.startsWith("{")?Object.entries(JSON.parse(e.responseText)).map((([e,t])=>`${e} : ${t}`)).join("\n"):e.responseText;alert(`「${t.innerText}」\n ${n}`),console.log(`「${t.innerText}」 ${n}`),t.innerText=a}))}static#n(e,t){for(const a of document.querySelectorAll(".edit3-tag"))a.innerText.includes(e)&&(a.innerText=a.innerText.replace(e,t));const a=document.querySelector("#work-tag-group");for(const n of a?.options)n.text===e&&(n.text=t);const n=document.querySelector("#select-catalog-tag-groups");for(const a of n?.options)a.text===e&&(a.text=t);$(n)?.val(null).trigger("change")}}class s{constructor(e){this.targetTerm=e.getAttribute("data-keyterm"),this.columns=new Map;for(const t of e.querySelectorAll(".editable")){const e=t.classList.item(0);this.columns.set(e,t),t.contentEditable=!0,t.setAttribute("data-value",t.innerText),t.addEventListener("keydown",(e=>{"Enter"===e.key&&e.preventDefault()})),t.addEventListener("focusout",(e=>{this.#e(e)})),t.addEventListener("focusin",(e=>{e.target.setAttribute("data-value",e.target.innerText)}))}}static init(){for(const e of document.querySelectorAll(".edit-synonym"))new s(e);new a("dialog-new-synonym","add-synonym","tab-content-manage_synonyms",this.#t)}static makeTableRow(e){const t=document.createElement("a");t.classList.add("icon","icon-del"),t.setAttribute("data-method","delete"),t.setAttribute("data-confirm","よろしいですか？"),t.setAttribute("rel","nofollow"),t.href=`/synonyms/${encodeURIComponent(e.term)}`,t.appendChild(document.createTextNode("削除"));const a=document.createElement("td");a.classList.add("term","editable"),a.appendChild(document.createTextNode(e.term));const n=document.createElement("td");n.classList.add("synonyms","multieditable"),n.appendChild(document.createTextNode(e.synonyms.join(",")));const o=document.createElement("td");o.classList.add("buttons"),o.appendChild(t);const i=document.createElement("tr");return i.setAttribute("data-keyterm",e.term),i.classList.add("edit-synonym"),i.appendChild(a),i.appendChild(n),i.appendChild(o),new s(i),i}static#t(e){if(!e)return;const t=e.querySelector("input[name='synonym[term]']").value,a=Array.from(e.querySelectorAll("input[name='synonym[synonyms][]']")).map((e=>e.value));$.ajax({type:"POST",url:"/synonyms.json",headers:{"X-Redmine-API-Key":IssuesCatalogSettingParam.user.apiKey},dataType:"text",format:"json",data:{synonym:{term:t,synonyms:a}}}).done((t=>{if(t.startsWith("{")){const a=document.querySelector("table.synonyms")?.querySelector("tbody");if(a){const n=JSON.parse(t),o=s.makeTableRow(n.synonym);a.appendChild(o),s.clearDialog(e)}}else console.log(t)})).fail(((e,t)=>{const a=e.responseText.startsWith("{")?Object.entries(JSON.parse(e.responseText)).map((([e,t])=>`${e} : ${t}`)).join("\n"):e.responseText;alert(a),console.log(a)}))}static clearDialog(e){for(const t of e.querySelectorAll(".synonym-words-added"))t.parentNode.removeChild(t);e.querySelector("input[name='synonym[term]']").value="",e.querySelector("input[name='synonym[synonyms][]']").value=""}#e(e){const t=e.target;t.innerText=t.innerText.replace(/[\r\n]/g,"");const a=t.getAttribute("data-value");if(a===t.innerText)return!0;if(0===t.innerText.length)return t.innerText=a,!0;e.preventDefault();const n=t.classList.item(0),o=t.innerText||"__none__",s={};s[n]=o,$.ajax({type:"PUT",url:`/synonyms/${encodeURIComponent(this.targetTerm)}.json`,headers:{"X-Redmine-API-Key":IssuesCatalogSettingParam.user.apiKey},dataType:"json",format:"json",data:{synonym:s}}).done(((e,s,i)=>{i.status>=200&&i.status<300||304===i.status?"term"===n&&(this.targetTerm=o,t.closest(".edit-synonym")?.setAttribute("data-keyterm",o)):t.innerText=a})).fail((e=>{const n=e.responseText.startsWith("{")?Object.entries(JSON.parse(e.responseText)).map((([e,t])=>`${e} : ${t}`)).join("\n"):e.responseText;alert(`「${t.innerText}」\n ${n}`),console.log(`「${t.innerText}」 ${n}`),t.innerText=a}))}}$((function(){e("#form-bulk-edit-tag-categories button","#select-catalog-tag-categories"),e("#form-bulk-edit-tag-groups button","#select-catalog-tag-groups"),$("input[type=checkbox].toggle-selection").on("change",(function(){const e=$(this).prop("checked");$(this).parents("table").find("input[name=ids\\[\\]]").prop("checked",e)})),n.init(),o.init(),s.init(),((e,t,a,n,o)=>{const s=e=>{const t=e.target;t.innerText=t.innerText.replace(/[\r\n]/g,"");const a=t.getAttribute("data-value");if(a===t.innerText)return!0;if(0===t.innerText.length)return t.innerText=a,!0;e.preventDefault();const n=t.parentNode?.id?.slice(4),o=t.classList.item(0),s=t.innerText||"__none__";return $.ajax({type:"PATCH",url:"/catalog_tags/field_update/",data:`id=${n}&catalog_tag[${o}]=${s}`}).done((function(e){"SUCCESS"!==e.status&&(console.log(`catalog_tag changed: ${n} : ${o} : ${s} : status ${e.status}`),e.message&&(alert(e.message),console.log(e.message)),t.innerText=a)})).fail((function(e,i){console.log(`catalog_tag change failed: ${n} : ${o} : ${s} : ${i}`),t.innerText=a})),!1};for(const e of document.querySelectorAll(".edit-tag"))e.contentEditable=!0,e.setAttribute("data-value",e.innerText),e.addEventListener("keydown",(function(e){"Enter"===e.key&&e.preventDefault()})),e.addEventListener("focusout",(function(e){s(e)})),e.addEventListener("focusin",(function(e){e.target.setAttribute("data-value",e.target.innerText)}))})(),t("#work-tag-category","catalog_tag_category_ids",".edit2-tag"),t("#work-tag-group","catalog_tag_group_ids",".edit3-tag")}))})();