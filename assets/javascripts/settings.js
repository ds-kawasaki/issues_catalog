(()=>{"use strict";const e=(e,t)=>{$(e).on("click",(function(){if(!$(t).val().length)return;const e=$(this).parents("form");e.find("[name=ids\\[\\]]").remove();let a=!1;$("input[name=ids\\[\\]]:checked").each((function(){$("<input>").attr({type:"hidden",name:"ids[]"}).val($(this).val()).appendTo(e),a=!0})),a&&(e.find("[name=operate]").val($(this).val()),e.submit())}))};class t{constructor(e){for(const t of e.querySelectorAll(".editable"))t.contentEditable=!0,t.addEventListener("keydown",(e=>{"Enter"===e.key&&e.preventDefault()}))}static#e=null;static#t=null;static#a=null;static init(){t.#e=null,t.#t=null,t.#a=new Map,document.addEventListener("click",(e=>t.#n(e)))}static registEdit(e,a,n){e&&t.#a.set(e,{callbackFocus:a,callbackBlur:n})}static updateToServer(e,t,a="PUT",n=null,o=null){$.ajax({type:a,url:e,headers:{"X-Redmine-API-Key":IssuesCatalogSettingParam.user.apiKey},dataType:"text",format:"json",data:t}).done(((e,t,a)=>{if(a.status>=200&&a.status<300||304===a.status){if(n){const t="string"==typeof e&&e.startsWith("{")?JSON.parse(e):{};n(t)}}else o&&o(null)})).fail((e=>{const t=e.responseText.startsWith("{")?Object.entries(JSON.parse(e.responseText)).map((([e,t])=>`${e} : ${t}`)).join("\n"):e.responseText;o&&o(t)}))}static#n(e){const a=e.target;if(a===t.#e);else{const n=t.#o(a);n?(t.#t&&t.#e&&t.#t(t.#e),n.callbackFocus&&n.callbackFocus(e),t.#e=a,t.#t=n.callbackBlur):t.#r(a)||t.#i(a)||(t.#t&&t.#e&&t.#t(t.#e),t.#e=null,t.#t=null)}}static#o(e){let a=null,n=t.#a.get(e.className);return void 0!==n?n:(e.classList.forEach((e=>{n=t.#a.get(e),void 0!==n&&(a=n)})),a)}static#r(e){for(let a=e;a;a=a.parentElement)if(a===t.#e)return!0;return!1}static#i(e){for(let t=e;t;t=t.parentElement)if(t.classList.contains("select2-container--open"))return!0;return!1}}class a extends t{constructor(e){super(e),e.targetId=e.id.slice(4)}static init(){for(const e of document.querySelectorAll(".edit-tag"))new a(e);t.registEdit("name tag editable",a.#s,a.#c),t.registEdit("description tag editable",a.#s,a.#c),t.registEdit("category tag multiselect",a.#l,a.#d),t.registEdit("group tag multiselect",a.#u,a.#g)}static#s(e){const t=e.target;t.setAttribute("data-value",t.innerText)}static#c(e){e.innerText=e.innerText.replace(/[\r\n]/g,"");const t=e.getAttribute("data-value");if(t===e.innerText)return!0;if(0===e.innerText.length)return e.innerText=t,!0;const n=e.classList.item(0),o=e.innerText||"__none__";a.#m(e,t,n,o)}static#l(e){a.#p(e,"#work-tag-category")}static#d(e){a.#y(e,"catalog_tag_category_ids")}static#u(e){a.#p(e,"#work-tag-group")}static#g(e){a.#y(e,"catalog_tag_group_ids")}static#p(e,t){const n=e.target;if(n.querySelector(".tmp-select"))return;n.setAttribute("data-value",n.innerText);const o=a.#T(n.innerText,"tmp-select",`tmp-select-${n.parentElement.targetId}`,t);n.innerText="",n.appendChild(o),a.#b($(o))}static#y(e,t){if(!e)return;const n=e.querySelector(".tmp-select");if(!n)return;$(n).select2("close");const o=Array.from(n.options).filter((e=>e.selected)).map((e=>e.text)).join(", ");let r=Array.from(n.options).filter((e=>e.selected)).map((e=>e.value));for(0==r.length&&(r=[""]);e.firstChild;)e.removeChild(e.firstChild);e.innerText=o;const i=e.getAttribute("data-value");i!==o&&a.#m(e,i,t,r)}static#T(e,t,a,n){const o=document.querySelector(n),r=e.split(",").map((e=>e.trim())),i=document.createElement("select");i.id=a,i.className=t,i.multiple=!0;for(const e of o.options){const t=document.createElement("option");t.value=e.value,t.text=e.text,r.includes(t.text)&&t.setAttribute("selected","selected"),i.appendChild(t)}return i}static#b(e){e.select2({width:"resolve",placeholder:"Multi-select",closeOnSelect:!1,allowClear:!1}),e.select2("open")}static#m(e,a,n,o){const r={id:e.parentElement.targetId,catalog_tag:{[n]:o}};t.updateToServer("/catalog_tags/field_update/",r,"PATCH",(t=>{"SUCCESS"===t.status||(console.log(`tag change fail: ${e.parentElement.targetId} : ${n} : ${o} : status ${t.status}`),t.message&&(alert(t.message),console.log(t.message)),e.innerText=a)}),(t=>{t&&(alert(t),console.log(t)),e.innerText=a}))}}class n{constructor(e,t,a,n){this.dialog=document.getElementById(e),this.trigger=document.getElementById(t),this.backGround=document.getElementById(a),this.submitCallback=n,this.setupShowDialog(),this.setupHideDialog()}setupShowDialog(){this.trigger?.addEventListener("click",(()=>{this.dialog&&(this.dialog.showModal(),this.dialog.style.visibility="visible",this.dialog.classList.remove("is-motioned"),this.dialog.setAttribute("tabIndex","0"),this.dialog.focus())}))}setupHideDialog(){this.dialog&&(this.dialog.querySelector(".dialog-button-submit")?.addEventListener("click",(()=>{this.submitCallback&&this.submitCallback(this.dialog),this.hideProcess("submit")})),this.dialog.querySelector(".dialog-button-cancel")?.addEventListener("click",(()=>{this.hideProcess("cancel")})),this.dialog.addEventListener("cancel",(()=>{this.hideProcess("cancel from escape key")})))}hideProcess(e){this.dialog&&(this.dialog.close(e),this.dialog.classList.add("is-motioned"),this.backGround&&(this.backGround.setAttribute("tabIndex","0"),this.backGround.focus()),setTimeout((()=>{this.dialog.style.visibility="hidden"}),250))}}class o extends t{constructor(e){super(e),e.targetId=e.id.slice(21)}static init(){for(const e of document.querySelectorAll(".edit-category"))new o(e);new n("dialog-new-catalog-tag-category","add-catalog-tag-category","tab-content-manage_tag_categories",o.#h),t.registEdit("name category editable",o.#s,o.#c),t.registEdit("description category editable",o.#s,o.#c)}static makeTableRow(e){const t=document.createElement("a");t.className="icon icon-del",t.setAttribute("data-method","delete"),t.setAttribute("data-confirm","よろしいですか？"),t.setAttribute("rel","nofollow"),t.href=`/catalog_tag_categories/${e.id}`,t.appendChild(document.createTextNode("削除"));const a=document.createElement("td");a.className="name category editable",a.appendChild(document.createTextNode(e.name));const n=document.createElement("td");n.className="description category editable",n.appendChild(document.createTextNode(e.description));const r=document.createElement("td");r.className="buttons",r.appendChild(t);const i=document.createElement("tr");return i.id=`catalog_tag_category-${e.id}`,i.className="edit-category",i.appendChild(a),i.appendChild(n),i.appendChild(r),new o(i),i}static#h(e){if(!e)return;const a=`/projects/${IssuesCatalogSettingParam.project?.identifier}/catalog_tag_categories.json`,n={catalog_tag_category:{name:e.querySelector("input[name='catalog_tag_category[name]']").value,description:e.querySelector("input[name='catalog_tag_category[description]']").value}};t.updateToServer(a,n,"POST",(e=>{const t=document.querySelector("table.catalog-tag-categories")?.querySelector("tbody");if("catalog_tag_category"in e&&t){const a=o.makeTableRow(e.catalog_tag_category);t.insertBefore(a,t.lastElementChild),o.#f(e.catalog_tag_category)}else console.log(e)}),(e=>{e&&(alert(e),console.log(e))}))}static#s(e){const t=e.target;t.setAttribute("data-value",t.innerText)}static#c(e){e.innerText=e.innerText.replace(/[\r\n]/g,"");const a=e.getAttribute("data-value");if(a===e.innerText)return!0;if(0===e.innerText.length)return e.innerText=a,!0;const n=e.classList.item(0),r=e.innerText||"__none__",i=`/catalog_tag_categories/${e.parentElement.targetId}.json`,s={catalog_tag_category:{[n]:r}};t.updateToServer(i,s,"PUT",(()=>{"name"===n&&o.#x(a,r)}),(t=>{t&&(alert(`「${e.innerText}」\n ${t}`),console.log(`「${e.innerText}」 ${t}`)),e.innerText=a}))}static#x(e,t){for(const a of document.querySelectorAll(".category.tag.multiselect"))a.innerText.includes(e)&&(a.innerText=a.innerText.replace(e,t));const a=document.querySelector("#work-tag-category");for(const n of a?.options)n.text===e&&(n.text=t);const n=document.querySelector("#select-catalog-tag-categories");for(const a of n?.options)a.text===e&&(a.text=t);$(n)?.val(null).trigger("change")}static#f(e){const t=document.querySelector("#work-tag-category");t&&t.insertBefore(o.#S(e),t.lastElementChild);const a=document.querySelector("#select-catalog-tag-categories");a&&a.insertBefore(o.#S(e),a.lastElementChild)}static#S(e){const t=document.createElement("option");return t.value=e.id,t.text=e.name,t}}class r extends t{constructor(e){super(e,"editable-group"),e.targetId=e.id.slice(18)}static init(){for(const e of document.querySelectorAll(".edit-group"))new r(e);new n("dialog-new-catalog-tag-group","add-catalog-tag-group","tab-content-manage_tag_groups",r.#h),t.registEdit("name group editable",r.#s,r.#c),t.registEdit("description group editable",r.#s,r.#c)}static makeTableRow(e){const t=document.createElement("a");t.className="icon icon-del",t.setAttribute("data-method","delete"),t.setAttribute("data-confirm","よろしいですか？"),t.setAttribute("rel","nofollow"),t.href=`/catalog_tag_groups/${e.id}`,t.appendChild(document.createTextNode("削除"));const a=document.createElement("td");a.className="name group editable",a.appendChild(document.createTextNode(e.name));const n=document.createElement("td");n.className="description group editable",n.appendChild(document.createTextNode(e.description));const o=document.createElement("td");o.classname="buttons",o.appendChild(t);const i=document.createElement("tr");return i.id=`catalog_tag_group-${e.id}`,i.className="edit-group",i.appendChild(a),i.appendChild(n),i.appendChild(o),new r(i),i}static#h(e){if(!e)return;const a=`/projects/${IssuesCatalogSettingParam.project?.identifier}/catalog_tag_groups.json`,n={catalog_tag_group:{name:e.querySelector("input[name='catalog_tag_group[name]']").value,description:e.querySelector("input[name='catalog_tag_group[description]']").value}};t.updateToServer(a,n,"POST",(e=>{const t=document.querySelector("table.catalog-tag-groups")?.querySelector("tbody");if("catalog_tag_group"in e&&t){const a=r.makeTableRow(e.catalog_tag_group);t.appendChild(a),r.#E(e.catalog_tag_group)}else console.log(e)}),(e=>{e&&(alert(e),console.log(e))}))}static#s(e){const t=e.target;t.setAttribute("data-value",t.innerText)}static#c(e){e.innerText=e.innerText.replace(/[\r\n]/g,"");const a=e.getAttribute("data-value");if(a===e.innerText)return!0;if(0===e.innerText.length)return e.innerText=a,!0;const n=e.classList.item(0),o=e.innerText||"__none__",i=`/catalog_tag_groups/${e.parentElement.targetId}.json`,s={catalog_tag_group:{[n]:o}};t.updateToServer(i,s,"PUT",(()=>{"name"===n&&r.#_(a,o)}),(t=>{t&&(alert(`「${e.innerText}」\n ${t}`),console.log(`「${e.innerText}」 ${t}`)),e.innerText=a}))}static#_(e,t){for(const a of document.querySelectorAll(".group.tag.multiselect"))a.innerText.includes(e)&&(a.innerText=a.innerText.replace(e,t));const a=document.querySelector("#work-tag-group");for(const n of a?.options)n.text===e&&(n.text=t);const n=document.querySelector("#select-catalog-tag-groups");for(const a of n?.options)a.text===e&&(a.text=t);$(n)?.val(null).trigger("change")}static#E(e){const t=document.querySelector("#work-tag-group");t&&t.appendChild(r.#S(e));const a=document.querySelector("#select-catalog-tag-groups");a&&a.appendChild(r.#S(e))}static#S(e){const t=document.createElement("option");return t.value=e.id,t.text=e.name,t}}class i extends t{constructor(e){super(e),i.#k(e)}static init(){for(const e of document.querySelectorAll(".edit-synonym"))new i(e);new n("dialog-new-synonym","add-synonym","tab-content-manage_synonyms",i.#h),t.registEdit("term synonym editable",i.#s,i.#c),t.registEdit("synonyms synonym multieditable",i.#v,i.#w)}static makeTableRow(e){const t=document.createElement("a");t.className="icon icon-del",t.setAttribute("data-method","delete"),t.setAttribute("data-confirm","よろしいですか？"),t.setAttribute("rel","nofollow"),t.href=`/synonyms/${encodeURIComponent(e.term)}`,t.appendChild(document.createTextNode("削除"));const a=document.createElement("td");a.className="term synonym editable",a.appendChild(document.createTextNode(e.term));const n=document.createElement("td");n.className="synonyms synonym multieditable",n.appendChild(document.createTextNode(e.synonyms.join(",")));const o=document.createElement("td");o.className="buttons",o.appendChild(t);const r=document.createElement("tr");return r.setAttribute("data-keyterm",e.term),r.className="edit-synonym",r.appendChild(a),r.appendChild(n),r.appendChild(o),new i(r),r}static#h(e){if(!e)return;const a={synonym:{term:e.querySelector("input[name='synonym[term]']").value,synonyms:e.querySelector("input[name='synonym[synonyms][]']").value.split(",")}};t.updateToServer("/synonyms.json",a,"POST",(t=>{const a=document.querySelector("table.synonyms")?.querySelector("tbody");if("synonym"in t&&a){const n=i.makeTableRow(t.synonym);a.appendChild(n),i.clearDialog(e)}else console.log(t)}),(e=>{e&&(alert(e),console.log(e))}))}static clearDialog(e){e.querySelector("input[name='synonym[term]']").value="";const t=e.querySelector("input[name='synonym[synonyms][]']");t.value="",$(t).tagit("removeAll")}static#v(e){const t=e.target;if(t.querySelector(".tmp-edit"))return;t.setAttribute("data-value",t.innerText);const a=document.createElement("input");a.setAttribute("type","text"),a.setAttribute("value",t.innerText),a.className="tmp-edit",t.innerText="",t.appendChild(a),$(a).tagit({caseSensitive:!1,removeConfirmation:!0})}static#w(e){if(!e)return;const a=e.querySelector(".tmp-edit");if(!a)return;const n=a.value;for(;e.firstChild;)e.removeChild(e.firstChild);e.innerText=n;const o=e.getAttribute("data-value");if(o===n)return;const r=`/synonyms/${encodeURIComponent(e.parentElement.getAttribute("data-keyterm"))}.json`,i={synonym:{[e.classList.item(0)]:n.split(",")}};t.updateToServer(r,i,"PUT",null,(t=>{t&&(alert(`「${e.innerText}」\n ${t}`),console.log(`「${e.innerText}」 ${t}`)),e.innerText=o}))}static#s(e){const t=e.target;t.setAttribute("data-value",t.innerText)}static#c(e){e.innerText=e.innerText.replace(/[\r\n]/g,"");const a=e.getAttribute("data-value");if(a===e.innerText)return!0;if(0===e.innerText.length)return e.innerText=a,!0;const n=e.classList.item(0),o=e.innerText||"__none__",r=`/synonyms/${encodeURIComponent(e.parentElement.getAttribute("data-keyterm"))}.json`,i={synonym:{[n]:o}};t.updateToServer(r,i,"PUT",(()=>{"term"===n&&e.parentElement.setAttribute("data-keyterm",o)}),(t=>{t&&(alert(`「${e.innerText}」\n ${t}`),console.log(`「${e.innerText}」 ${t}`)),e.innerText=a}))}static#k(e){const a=e.querySelector("a.icon-del");a&&a.addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation();const a=e.target,n=a.getAttribute("data-confirm");if(n&&!window.confirm(n))return!1;const o=`${new URL(a.href).pathname}.json`;return t.updateToServer(o,{},"DELETE",(()=>{document.location.reload()}),(e=>{e&&(alert(e),console.log(e))})),!1}))}}$((function(){e("#form-bulk-edit-tag-categories button","#select-catalog-tag-categories"),e("#form-bulk-edit-tag-groups button","#select-catalog-tag-groups"),$("input[type=checkbox].toggle-selection").on("change",(function(){const e=$(this).prop("checked");$(this).parents("table").find("input[name=ids\\[\\]]").prop("checked",e)})),t.init(),a.init(),o.init(),r.init(),i.init(),(()=>{const e=new URL(document.location).searchParams.get("sub_tab");if(e){const t=document.getElementById(`tab-${e}`);t&&t.click()}})()}))})();