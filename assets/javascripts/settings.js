(()=>{"use strict";const t=(t,e)=>{$(t).on("click",(function(){if(!$(e).val().length)return;const t=$(this).parents("form");t.find("[name=ids\\[\\]]").remove();let a=!1;$("input[name=ids\\[\\]]:checked").each((function(){$("<input>").attr({type:"hidden",name:"ids[]"}).val($(this).val()).appendTo(t),a=!0})),a&&(t.find("[name=operate]").val($(this).val()),t.submit())}))};class e{constructor(t){for(const e of t.querySelectorAll(".editable"))e.contentEditable=!0,e.addEventListener("keydown",(t=>{"Enter"===t.key&&t.preventDefault()}))}static#t=null;static#e=null;static#a=null;static init(){e.#t=null,e.#e=null,e.#a=new Map,document.addEventListener("click",(t=>e.#n(t)))}static registEdit(t,a,n){t&&e.#a.set(t,{callbackFocus:a,callbackBlur:n})}static updateToServer(t,e,a="PUT",n=null,o=null){$.ajax({type:a,url:t,headers:{"X-Redmine-API-Key":IssuesCatalogSettingParam.user.apiKey},dataType:"text",format:"json",data:e}).done(((t,e,a)=>{if(a.status>=200&&a.status<300||304===a.status){if(n){const e="string"==typeof t&&t.startsWith("{")?JSON.parse(t):{};n(e)}}else o&&o(null)})).fail((t=>{const e=t.responseText.startsWith("{")?Object.entries(JSON.parse(t.responseText)).map((([t,e])=>`${t} : ${e}`)).join("\n"):t.responseText;o&&o(e)}))}static#n(t){const a=t.target;if(a===e.#t);else{const n=e.#o(a);n?(e.#e&&e.#t&&e.#e(e.#t),n.callbackFocus&&n.callbackFocus(t),e.#t=a,e.#e=n.callbackBlur):e.#i(a)||e.#r(a)||(e.#e&&e.#t&&e.#e(e.#t),e.#t=null,e.#e=null)}}static#o(t){let a=null,n=e.#a.get(t.className);return void 0!==n?n:(t.classList.forEach((t=>{n=e.#a.get(t),void 0!==n&&(a=n)})),a)}static#i(t){for(let a=t;a;a=a.parentElement)if(a===e.#t)return!0;return!1}static#r(t){for(let e=t;e;e=e.parentElement)if(e.classList.contains("select2-container--open"))return!0;return!1}}class a extends e{constructor(t){super(t),t.targetId=t.id.slice(4)}static init(){for(const t of document.querySelectorAll(".edit-tag"))new a(t);e.registEdit("name tag editable",this.#s,this.#c),e.registEdit("description tag editable",this.#s,this.#c),e.registEdit("category tag multiselect",this.#l,this.#d),e.registEdit("group tag multiselect",this.#u,this.#g)}static#s(t){const e=t.target;e.setAttribute("data-value",e.innerText)}static#c(t){t.innerText=t.innerText.replace(/[\r\n]/g,"");const e=t.getAttribute("data-value");if(e===t.innerText)return!0;if(0===t.innerText.length)return t.innerText=e,!0;const n=t.classList.item(0),o=t.innerText||"__none__";a.#m(t,e,n,o)}static#l(t){a.#p(t,"#work-tag-category")}static#d(t){a.#y(t,"catalog_tag_category_ids")}static#u(t){a.#p(t,"#work-tag-group")}static#g(t){a.#y(t,"catalog_tag_group_ids")}static#p(t,e){const n=t.target;if(n.querySelector(".tmp-select"))return;n.setAttribute("data-value",n.innerText);const o=a.#h(n.innerText,"tmp-select",`tmp-select-${n.parentElement.targetId}`,e);n.innerText="",n.appendChild(o),a.#T($(o))}static#y(t,e){if(!t)return;const n=t.querySelector(".tmp-select");if(!n)return;$(n).select2("close");const o=Array.from(n.options).filter((t=>t.selected)).map((t=>t.text)).join(", ");let i=Array.from(n.options).filter((t=>t.selected)).map((t=>t.value));for(0==i.length&&(i=[""]);t.firstChild;)t.removeChild(t.firstChild);t.innerText=o;const r=t.getAttribute("data-value");r!==o&&a.#m(t,r,e,i)}static#h(t,e,a,n){const o=document.querySelector(n),i=t.split(",").map((t=>t.trim())),r=document.createElement("select");r.id=a,r.className=e,r.multiple=!0;for(const t of o.options){const e=document.createElement("option");e.value=t.value,e.text=t.text,i.includes(e.text)&&e.setAttribute("selected","selected"),r.appendChild(e)}return r}static#T(t){t.select2({width:"resolve",placeholder:"Multi-select",closeOnSelect:!1,allowClear:!1}),t.select2("open")}static#m(t,a,n,o){const i={id:t.parentElement.targetId,catalog_tag:{[n]:o}};e.updateToServer("/catalog_tags/field_update/",i,"PATCH",(e=>{"SUCCESS"===e.status||(console.log(`tag change fail: ${t.parentElement.targetId} : ${n} : ${o} : status ${e.status}`),e.message&&(alert(e.message),console.log(e.message)),t.innerText=a)}),(e=>{e&&(alert(e),console.log(e)),t.innerText=a}))}}class n{constructor(t,e,a,n){this.dialog=document.getElementById(t),this.trigger=document.getElementById(e),this.backGround=document.getElementById(a),this.submitCallback=n,this.setupShowDialog(),this.setupHideDialog()}setupShowDialog(){this.trigger?.addEventListener("click",(()=>{this.dialog&&(this.dialog.showModal(),this.dialog.style.visibility="visible",this.dialog.classList.remove("is-motioned"),this.dialog.setAttribute("tabIndex","0"),this.dialog.focus())}))}setupHideDialog(){this.dialog&&(this.dialog.querySelector(".dialog-button-submit")?.addEventListener("click",(()=>{this.submitCallback&&this.submitCallback(this.dialog),this.hideProcess("submit")})),this.dialog.querySelector(".dialog-button-cancel")?.addEventListener("click",(()=>{this.hideProcess("cancel")})),this.dialog.addEventListener("cancel",(()=>{this.hideProcess("cancel from escape key")})))}hideProcess(t){this.dialog&&(this.dialog.close(t),this.dialog.classList.add("is-motioned"),this.backGround&&(this.backGround.setAttribute("tabIndex","0"),this.backGround.focus()),setTimeout((()=>{this.dialog.style.visibility="hidden"}),250))}}class o extends e{constructor(t){super(t),t.targetId=t.id.slice(21)}static init(){for(const t of document.querySelectorAll(".edit-category"))new o(t);new n("dialog-new-catalog-tag-category","add-catalog-tag-category","tab-content-manage_tag_categories",this.#b),e.registEdit("name category editable",this.#s,this.#c),e.registEdit("description category editable",this.#s,this.#c)}static makeTableRow(t){const e=document.createElement("a");e.className="icon icon-del",e.setAttribute("data-method","delete"),e.setAttribute("data-confirm","よろしいですか？"),e.setAttribute("rel","nofollow"),e.href=`/catalog_tag_categories/${t.id}`,e.appendChild(document.createTextNode("削除"));const a=document.createElement("td");a.className="name category editable",a.appendChild(document.createTextNode(t.name));const n=document.createElement("td");n.className="description category editable",n.appendChild(document.createTextNode(t.description));const i=document.createElement("td");i.className="buttons",i.appendChild(e);const r=document.createElement("tr");return r.id=`catalog_tag_category-${t.id}`,r.className="edit-category",r.appendChild(a),r.appendChild(n),r.appendChild(i),new o(r),r}static#b(t){if(!t)return;const a=`/projects/${IssuesCatalogSettingParam.project?.identifier}/catalog_tag_categories.json`,n={catalog_tag_category:{name:t.querySelector("input[name='catalog_tag_category[name]']").value,description:t.querySelector("input[name='catalog_tag_category[description]']").value}};e.updateToServer(a,n,"POST",(t=>{const e=document.querySelector("table.catalog-tag-categories")?.querySelector("tbody");if("catalog_tag_category"in t&&e){const a=o.makeTableRow(t.catalog_tag_category);e.insertBefore(a,e.lastElementChild),o.#f(t.catalog_tag_category)}else console.log(t)}),(t=>{t&&(alert(t),console.log(t))}))}static#s(t){const e=t.target;e.setAttribute("data-value",e.innerText)}static#c(t){t.innerText=t.innerText.replace(/[\r\n]/g,"");const a=t.getAttribute("data-value");if(a===t.innerText)return!0;if(0===t.innerText.length)return t.innerText=a,!0;const n=t.classList.item(0),i=t.innerText||"__none__",r=`/catalog_tag_categories/${t.parentElement.targetId}.json`,s={catalog_tag_category:{[n]:i}};e.updateToServer(r,s,"PUT",(()=>{"name"===n&&o.#x(a,i)}),(e=>{e&&(alert(`「${t.innerText}」\n ${e}`),console.log(`「${t.innerText}」 ${e}`)),t.innerText=a}))}static#x(t,e){for(const a of document.querySelectorAll(".category.tag.multiselect"))a.innerText.includes(t)&&(a.innerText=a.innerText.replace(t,e));const a=document.querySelector("#work-tag-category");for(const n of a?.options)n.text===t&&(n.text=e);const n=document.querySelector("#select-catalog-tag-categories");for(const a of n?.options)a.text===t&&(a.text=e);$(n)?.val(null).trigger("change")}static#f(t){const e=document.querySelector("#work-tag-category");e&&e.insertBefore(o.#S(t),e.lastElementChild);const a=document.querySelector("#select-catalog-tag-categories");a&&a.insertBefore(o.#S(t),a.lastElementChild)}static#S(t){const e=document.createElement("option");return e.value=t.id,e.text=t.name,e}}class i extends e{constructor(t){super(t,"editable-group"),t.targetId=t.id.slice(18)}static init(){for(const t of document.querySelectorAll(".edit-group"))new i(t);new n("dialog-new-catalog-tag-group","add-catalog-tag-group","tab-content-manage_tag_groups",this.#b),e.registEdit("name group editable",this.#s,this.#c),e.registEdit("description group editable",this.#s,this.#c)}static makeTableRow(t){const e=document.createElement("a");e.className="icon icon-del",e.setAttribute("data-method","delete"),e.setAttribute("data-confirm","よろしいですか？"),e.setAttribute("rel","nofollow"),e.href=`/catalog_tag_groups/${t.id}`,e.appendChild(document.createTextNode("削除"));const a=document.createElement("td");a.className="name group editable",a.appendChild(document.createTextNode(t.name));const n=document.createElement("td");n.className="description group editable",n.appendChild(document.createTextNode(t.description));const o=document.createElement("td");o.classname="buttons",o.appendChild(e);const r=document.createElement("tr");return r.id=`catalog_tag_group-${t.id}`,r.className="edit-group",r.appendChild(a),r.appendChild(n),r.appendChild(o),new i(r),r}static#b(t){if(!t)return;const a=`/projects/${IssuesCatalogSettingParam.project?.identifier}/catalog_tag_groups.json`,n={catalog_tag_group:{name:t.querySelector("input[name='catalog_tag_group[name]']").value,description:t.querySelector("input[name='catalog_tag_group[description]']").value}};e.updateToServer(a,n,"POST",(t=>{const e=document.querySelector("table.catalog-tag-groups")?.querySelector("tbody");if("catalog_tag_group"in t&&e){const a=i.makeTableRow(t.catalog_tag_group);e.appendChild(a),i.#_(t.catalog_tag_group)}else console.log(t)}),(t=>{t&&(alert(t),console.log(t))}))}static#s(t){const e=t.target;e.setAttribute("data-value",e.innerText)}static#c(t){t.innerText=t.innerText.replace(/[\r\n]/g,"");const a=t.getAttribute("data-value");if(a===t.innerText)return!0;if(0===t.innerText.length)return t.innerText=a,!0;const n=t.classList.item(0),o=t.innerText||"__none__",r=`/catalog_tag_groups/${t.parentElement.targetId}.json`,s={catalog_tag_group:{[n]:o}};e.updateToServer(r,s,"PUT",(()=>{"name"===n&&i.#E(a,o)}),(e=>{e&&(alert(`「${t.innerText}」\n ${e}`),console.log(`「${t.innerText}」 ${e}`)),t.innerText=a}))}static#E(t,e){for(const a of document.querySelectorAll(".group.tag.multiselect"))a.innerText.includes(t)&&(a.innerText=a.innerText.replace(t,e));const a=document.querySelector("#work-tag-group");for(const n of a?.options)n.text===t&&(n.text=e);const n=document.querySelector("#select-catalog-tag-groups");for(const a of n?.options)a.text===t&&(a.text=e);$(n)?.val(null).trigger("change")}static#_(t){const e=document.querySelector("#work-tag-group");e&&e.appendChild(i.#S(t));const a=document.querySelector("#select-catalog-tag-groups");a&&a.appendChild(i.#S(t))}static#S(t){const e=document.createElement("option");return e.value=t.id,e.text=t.name,e}}class r extends e{constructor(t){super(t)}static init(){for(const t of document.querySelectorAll(".edit-synonym"))new r(t);new n("dialog-new-synonym","add-synonym","tab-content-manage_synonyms",this.#b),e.registEdit("term synonym editable",this.#s,this.#c),e.registEdit("synonyms synonym multieditable",this.#k,this.#v)}static makeTableRow(t){const e=document.createElement("a");e.className="icon icon-del",e.setAttribute("data-method","delete"),e.setAttribute("data-confirm","よろしいですか？"),e.setAttribute("rel","nofollow"),e.href=`/synonyms/${encodeURIComponent(t.term)}`,e.appendChild(document.createTextNode("削除"));const a=document.createElement("td");a.className="term synonym editable",a.appendChild(document.createTextNode(t.term));const n=document.createElement("td");n.className="synonyms synonym multieditable",n.appendChild(document.createTextNode(t.synonyms.join(",")));const o=document.createElement("td");o.className="buttons",o.appendChild(e);const i=document.createElement("tr");return i.setAttribute("data-keyterm",t.term),i.className="edit-synonym",i.appendChild(a),i.appendChild(n),i.appendChild(o),new r(i),i}static#b(t){if(!t)return;const a={synonym:{term:t.querySelector("input[name='synonym[term]']").value,synonyms:t.querySelector("input[name='synonym[synonyms][]']").value.split(",")}};e.updateToServer("/synonyms.json",a,"POST",(e=>{const a=document.querySelector("table.synonyms")?.querySelector("tbody");if("synonym"in e&&a){const n=r.makeTableRow(e.synonym);a.appendChild(n),r.clearDialog(t)}else console.log(e)}),(t=>{t&&(alert(t),console.log(t))}))}static clearDialog(t){t.querySelector("input[name='synonym[term]']").value="";const e=t.querySelector("input[name='synonym[synonyms][]']");e.value="",$(e).tagit("removeAll")}static#k(t){const e=t.target;if(e.querySelector(".tmp-edit"))return;e.setAttribute("data-value",e.innerText);const a=document.createElement("input");a.setAttribute("type","text"),a.setAttribute("value",e.innerText),a.className="tmp-edit",e.innerText="",e.appendChild(a),$(a).tagit({caseSensitive:!1,removeConfirmation:!0})}static#v(t){if(!t)return;const a=t.querySelector(".tmp-edit");if(!a)return;const n=a.value;for(;t.firstChild;)t.removeChild(t.firstChild);t.innerText=n;const o=t.getAttribute("data-value");if(o===n)return;const i=`/synonyms/${encodeURIComponent(t.parentElement.getAttribute("data-keyterm"))}.json`,r={synonym:{[t.classList.item(0)]:n.split(",")}};e.updateToServer(i,r,"PUT",null,(e=>{e&&(alert(`「${t.innerText}」\n ${e}`),console.log(`「${t.innerText}」 ${e}`)),t.innerText=o}))}static#s(t){const e=t.target;e.setAttribute("data-value",e.innerText)}static#c(t){t.innerText=t.innerText.replace(/[\r\n]/g,"");const a=t.getAttribute("data-value");if(a===t.innerText)return!0;if(0===t.innerText.length)return t.innerText=a,!0;const n=t.classList.item(0),o=t.innerText||"__none__",i=`/synonyms/${encodeURIComponent(t.parentElement.getAttribute("data-keyterm"))}.json`,r={synonym:{[n]:o}};e.updateToServer(i,r,"PUT",(()=>{"term"===n&&t.parentElement.setAttribute("data-keyterm",o)}),(e=>{e&&(alert(`「${t.innerText}」\n ${e}`),console.log(`「${t.innerText}」 ${e}`)),t.innerText=a}))}}$((function(){t("#form-bulk-edit-tag-categories button","#select-catalog-tag-categories"),t("#form-bulk-edit-tag-groups button","#select-catalog-tag-groups"),$("input[type=checkbox].toggle-selection").on("change",(function(){const t=$(this).prop("checked");$(this).parents("table").find("input[name=ids\\[\\]]").prop("checked",t)})),e.init(),a.init(),o.init(),i.init(),r.init()}))})();