(()=>{"use strict";const t=(t,e)=>{$(t).on("click",(function(){if(!$(e).val().length)return;const t=$(this).parents("form");t.find("[name=ids\\[\\]]").remove();let a=!1;$("input[name=ids\\[\\]]:checked").each((function(){$("<input>").attr({type:"hidden",name:"ids[]"}).val($(this).val()).appendTo(t),a=!0})),a&&(t.find("[name=operate]").val($(this).val()),t.submit())}))};class e{constructor(t,e,a,n){this.dialog=document.getElementById(t),this.trigger=document.getElementById(e),this.backGround=document.getElementById(a),this.submitCallback=n,this.setupShowDialog(),this.setupHideDialog()}setupShowDialog(){this.trigger?.addEventListener("click",(()=>{this.dialog&&(this.dialog.showModal(),this.dialog.style.visibility="visible",this.dialog.classList.remove("is-motioned"),this.dialog.setAttribute("tabIndex","0"),this.dialog.focus())}))}setupHideDialog(){this.dialog&&(this.dialog.querySelector(".dialog-button-submit")?.addEventListener("click",(()=>{this.submitCallback&&this.submitCallback(this.dialog),this.hideProcess("submit")})),this.dialog.querySelector(".dialog-button-cancel")?.addEventListener("click",(()=>{this.hideProcess("cancel")})),this.dialog.addEventListener("cancel",(()=>{this.hideProcess("cancel from escape key")})))}hideProcess(t){this.dialog&&(this.dialog.close(t),this.dialog.classList.add("is-motioned"),this.backGround&&(this.backGround.setAttribute("tabIndex","0"),this.backGround.focus()),setTimeout((()=>{this.dialog.style.visibility="hidden"}),250))}}const a=(t,e,a,n,o)=>{const s=t=>{const s=t.target;s.innerText=s.innerText.replace(/[\r\n]/g,"");const i=s.getAttribute("data-value");if(i===s.innerText)return!0;if(0===s.innerText.length)return s.innerText=i,!0;t.preventDefault();const r=s.parentNode?.id?.slice(e),c=s.classList.item(0),l=s.innerText||"__none__";return $.ajax({type:"PATCH",url:a,data:`id=${r}&${n}[${c}]=${l}`}).done((function(t){"SUCCESS"===t.status?"name"===c&&o&&o(r,i,l):(console.log(`${n} changed: ${r} : ${c} : ${l} : status ${t.status}`),t.message&&(alert(t.message),console.log(t.message)),s.innerText=i)})).fail((function(t,e){console.log(`${n} change failed: ${r} : ${c} : ${l} : ${e}`),s.innerText=i})),!1};for(const e of document.querySelectorAll(t))e.contentEditable=!0,e.setAttribute("data-value",e.innerText),e.addEventListener("keydown",(function(t){"Enter"===t.key&&t.preventDefault()})),e.addEventListener("focusout",(function(t){s(t)})),e.addEventListener("focusin",(function(t){t.target.setAttribute("data-value",t.target.innerText)}))},n=(t,e,a)=>{const n=document.querySelector(t);if(n){const t=(t,e,a)=>{const o=t.split(",").map((t=>t.trim())),s=document.createElement("select");s.id=a,s.className=e,s.multiple=!0;for(const t of n.options){const e=document.createElement("option");e.value=t.value,e.text=t.text,o.includes(e.text)&&e.setAttribute("selected","selected"),s.appendChild(e)}return s},o=(t,a,n)=>{t.select2({width:"resolve",placeholder:"Multi-select",closeOnSelect:!1,allowClear:!1}),t.select2("open"),t.on("select2:close",(function(t){const o=Array.from(this.options).filter((t=>t.selected)).map((t=>t.text)).join(", ");let s=Array.from(this.options).filter((t=>t.selected)).map((t=>t.value));for(0==s.length&&(s=[""]);a.firstChild;)a.removeChild(a.firstChild);a.innerText=o;const i=a.getAttribute("data-value");i!==o&&(t.preventDefault(),$.ajax({type:"PATCH",url:"/catalog_tags/field_update/",data:{id:n,catalog_tag:{[e]:s}},dataType:"json"}).done((function(t){"SUCCESS"===t.status||(console.log(`${paramName} changed: ${targetId} : ${column} : ${value} : status ${t.status}`),t.message&&(alert(t.message),console.log(t.message)),a.innerText=i)})).fail((function(t,e){console.log(`tag change failed: ${n} : ${s} : ${e}`),a.innerText=i})))}))};for(const e of document.querySelectorAll(a))e.addEventListener("click",(function(e){const a=this;if(a.querySelector(".tmp-select"))return;const n=a.parentNode?.id?.slice(4);a.setAttribute("data-value",a.innerText);const s=t(a.innerText,"tmp-select",`tmp-select-${n}`);a.innerText="",a.appendChild(s),o($(s),a,n)}))}};class o{constructor(t){this.targetId=t.id.slice(21),this.columns=new Map;for(const e of t.querySelectorAll(".editable")){const t=e.classList.item(0);this.columns.set(t,e),e.contentEditable=!0,e.setAttribute("data-value",e.innerText),e.addEventListener("keydown",(t=>{"Enter"===t.key&&t.preventDefault()})),e.addEventListener("focusout",(t=>{this.editedItem(t)})),e.addEventListener("focusin",(t=>{t.target.setAttribute("data-value",t.target.innerText)}))}}editedItem(t){const e=t.target;e.innerText=e.innerText.replace(/[\r\n]/g,"");const a=e.getAttribute("data-value");if(a===e.innerText)return!0;if(0===e.innerText.length)return e.innerText=a,!0;t.preventDefault();const n=this.makeParam();console.log(`id:${this.targetId} params:${n}`),console.dir(n),$.ajax({type:"PUT",url:`/catalog_tag_categories/${this.targetId}.json`,headers:{"X-Redmine-API-Key":IssuesCatalogSettingParam.user.apiKey},dataType:"json",format:"json",data:{catalog_tag_category:n}}).done((function(t,e,a){})).fail((function(t,n){const o=t.responseText.startsWith("{")?Object.entries(JSON.parse(t.responseText)).map((([t,e])=>`${t} : ${e}`)).join("\n"):t.responseText;alert(o),console.log(o),e.innerText=a}))}makeParam(){let t={};for(const[e,a]of this.columns)t[e]=a.innerText;return t}}$((function(){t("#form-bulk-edit-tag-categories button","#select-catalog-tag-categories"),t("#form-bulk-edit-tag-groups button","#select-catalog-tag-groups"),$("input[type=checkbox].toggle-selection").on("change",(function(){const t=$(this).prop("checked");$(this).parents("table").find("input[name=ids\\[\\]]").prop("checked",t)})),new e("dialog-new-catalog-tag-category","add-catalog-tag-category","tab-content-manage_tag_categories",(t=>{if(!t)return;const e=t.querySelector("input[name='catalog_tag_category[name]']").value,a=t.querySelector("input[name='catalog_tag_category[description]']").value,n=IssuesCatalogSettingParam.user.apiKey;let o=IssuesCatalogSettingParam.project?.identifier;console.log(`callbackNew: ${e} : ${a} : ${o} : ${n}`),$.ajax({type:"POST",url:`/projects/${o}/catalog_tag_categories.json`,headers:{"X-Redmine-API-Key":n},dataType:"text",format:"json",data:{catalog_tag_category:{name:e,description:a}}}).done((function(t){if(t.startsWith("{")){const e=JSON.parse(t),a=document.querySelector("table.catalog-tag-categories")?.querySelector("tbody");if(a){const t=document.createElement("tr");t.id=`catalog_tag_category-${e.catalog_tag_category.id}`;const n=document.createElement("td");n.classList.add("name","edit-category"),n.innerText=e.catalog_tag_category.name;const o=document.createElement("td");o.classList.add("description","edit-category"),o.innerText=e.catalog_tag_category.description,t.appendChild(n),t.appendChild(o),a.insertBefore(t,a.lastElementChild)}}else console.log(t)})).fail((function(t,e){const a=t.responseText.startsWith("{")?Object.entries(JSON.parse(t.responseText)).map((([t,e])=>`${t} : ${e}`)).join("\n"):t.responseText;alert(a),console.log(a)}))})),a(".edit-group",18,"/catalog_tag_groups/field_update/","catalog_tag_group",((t,e,a)=>{for(const t of document.querySelectorAll(".edit3-tag"))t.innerText.includes(e)&&(t.innerText=t.innerText.replace(e,a));const n=document.querySelector("#work-tag-group");for(const t of n?.options)t.text===e&&(t.text=a);const o=document.querySelector("#select-catalog-tag-groups");for(const t of o?.options)t.text===e&&(t.text=a);$(o)?.val(null).trigger("change")})),a(".edit-tag",4,"/catalog_tags/field_update/","catalog_tag",null);for(const t of document.querySelectorAll(".edit-category"))new o(t);n("#work-tag-category","catalog_tag_category_ids",".edit2-tag"),n("#work-tag-group","catalog_tag_group_ids",".edit3-tag")}))})();